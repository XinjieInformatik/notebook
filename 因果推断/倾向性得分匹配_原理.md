# 倾向性得分匹配 PSM - 原理

## 背景
互联网公司部门在业务的压力下，有时候没有 A/B test 的条件和流量，线上的样本表现可能是基于一些人工策略或者旧模型干预下的结果。这样的样本并不适合因果推断的建模，因为不同treatment下的用户往往是不同质的。无法在正交流量下去研究treatment T 对特征X同质的用户的影响作用。
举个🌰：业务线上策略，对于风险等级不同的用户，给到不同的定价。这个时候我们就无法去分析或者建模研究不同定价(作为treatment) 干预下，用户真实的响应。因为风险等级不同的用户特征和表现，天然是不同的。

在没有 A/B test 条件的情况下，我们是否能从线上不同策略间的用户中，找到一些同质（镜像）用户，去模拟 A/B test 中 treatment 对他们的影响？

**倾向性得分匹配** 的引入就是为了消除线上策略或模型作用下，不同分组用户的不同质。我们可以通过用户的倾向性得分，对于实验组的每一个样本，在对照组中找一个镜像样本。

## 介绍
倾向性得分：一个用户属于实验组的倾向性。
$$
e(x)=\operatorname{Pr}[T=1 \mid X=x]
$$
对于倾向性得分相同的一组用户, treatment和特征是独立的, treatment和潜在结果也是独立的。

如果对每个实验组用户都在对照组里匹配一个/几个得分相当的用户，就能得到同质的实验组和对照组，就可以模拟做了一个A/B test，在控制变量treatment下进行组间比较。

参考[Some Practical Guidance for the Implementation of Propensity Score Matching](http://ftp.iza.org/dp1588.pdf) 倾向分建模的步骤通常分为以下5部分
1. 倾向性得分估算
2. 倾向性得分匹配
3. 平衡性检查
4. 因果效应估算
5. 敏感度分析

## 核心思路
对倾向分建模其实就是：使用treatment当作Y, 样本的特征X作为特征，构建一个机器学习模型（逻辑回归，决策树，NN...），为每一个样本打分得到的就是倾向分。

思考：为什么把treatment当作Y呢？
我们其实想拿到的是无偏同质的样本在不同treatment下的表现（例如转化率），即把treatment作为分组依据，不同分组下的用户特征分布应该接近。通过匹配不同treatment下倾向分相同的样本，我们可以得到特征分布接近的样本对。

模型输入样本特征X，输出样本属于该treatment（该分组）的概率，如果两个样本的倾向分接近，则特征也是接近的。

换一个角度：假设线上有一个对照组和实验组，我们想验证这次线上探测是否足够无偏，我们可以使用样本的特征X作为特征，不同的分组作为Y（对照组0/实验组1），训练一个二分类模型。如果这个二分类模型的auc在0.5左右，就说明对照组和实验组之间是足够无偏的，因为模型无法通过用户特征区别用户的组别，因此不同组别下的用户是同质的。假如auc > 0.6，那么我们可以查看特征重要性高的特征，看看是哪些特征导致了组间的偏差。

到这里，其实倾向分的原理和作用就已经解释清楚了，接下来简单介绍一下主要的几个步骤。可以直接看看在具体数据集上的效果。

## 一. 倾向性得分估算
构建倾向分最简单的方式是使用一个标准的逻辑回归，将treatment作为label，使用样本特征X作为特征，建模输出样本的倾向性得分（样本属于实验组的概率）。
```python
propensity = LogisticRegression()
propensity = propensity.fit(data[feature_columns], data.Treated)
pscore = propensity.predict_proba(data[feature_columns])[:,1]
```

## 二. 倾向性得分匹配
当得到了每个用户的倾向分后，就可以将对照组和实验组间同质的用户（倾向分接近的样本）进行匹配。最简单的方法是使用knn进行无放回的匹配。具体的，对于每一个实验组用户，我们去对照组里找一个/几个倾向性得分最近的用户，把他们配成一对。匹配过程中，可以限制一下配对用户的得分差异不能超过某一个阈值，以防把不相似的用户匹配在一起。

## 三. 平衡性检查
1. 倾向性得分在匹配前后的分布、以及特征在匹配前后的 QQ-Plot(Quantile-Quantile Plots, 通过比较两个概率分布的分位数对这两个概率分布进行比较的概率图方法)
2. 配平效果的量化指标:SMD. 一种计算方式为：（实验组均值 - 对照组均值）/ 实验组标准差。如果一个特征的 SMD 不超过 0.1，一般就可以认为这个变量的配平质量可以接受。当一个变量的 SMD 超过 0.1 的时候，需要凭经验确认一下那个变量是不是没有那么重要。
3. auc变化 (y为treatment)

## 四. 因果效应推断
推断 ATT (Average Treatment Effect on the Treated)

## 五. 敏感性检查
衡量当混淆变量（特征）不满足 unconfoundedness 时，分析结论是不是 robust。



逆概率加权处理方法 (IPTW) 适用于多分组的情况

## 参考：
1. http://ftp.iza.org/dp1588.pdf
2. https://dango.rocks/blog/2019/01/20/Causal-Inference-Introduction2-Propensity-Score-Matching/
